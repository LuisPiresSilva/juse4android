package org.quasar.use2android.defaultdata.java;


import java.util.ArrayList;
import java.util.List;

import android.os.AsyncTask;
import android.util.Log;

import com.db4o.ObjectContainer;
import com.db4o.ObjectSet;
import com.db4o.cs.Db4oClientServer;

import TARGET_PACKAGE.MAIN_APPLICATION;
import DATABASE_PACKAGE.Database;
import BUSINESS_PACKAGE.ModelMusts;
import UTILS_PACKAGE.UtilNavigate;

public class ServerActions {

	private static AsyncTask<Void, String, Boolean> send_task;
	private static AsyncTask<Void, String, Boolean> get_task;

	public static void sendChanges() {
		send_task = new AsyncTask<Void, String, Boolean>() {
			@Override
			protected Boolean doInBackground(Void... params) {
				boolean error = false;
				List<AndroidTransaction> list = new ArrayList<AndroidTransaction>(Transactions.getAllInstances());
//				Log.i("server ttransactions lista", "size - "+ list.size());
//				Log.i("transactions lista",list.toString());
				AndroidTransaction transaction = null;
				
//				TEST
				for(int i = 0;i < list.size();++i){
					Log.i("Transaction", "inside transaction " + list.get(i).toString() + " - start");
					for(Command c : list.get(i).getCommands())
						Log.i("Command:", c.toString());
					Log.i("Transaction", "inside transaction " + list.get(i).toString() + " - end");
				}
				
//				if(transaction != null)
//					Log.i("got transaction", "" + transaction.toString());
				Log.i("Server connection", "vou abrir conecçao");
				try{
					ObjectContainer client = Db4oClientServer.openClient(Database.dbServerConfig(), ServerInfo.HOST, ServerInfo.PORT, ServerInfo.USER,	ServerInfo.PASS);
					Log.i("Server connection", "abri conecçao");
					try {
						ObjectContainer session = client.ext().openSession();
						Log.i("Server connection", "abri sessao");
						try {
							for(int i = 0;i < list.size();++i){
								transaction = list.get(i);
//								Log.i("Transaction", "inside transaction - start");
//								for(Command c : transaction.getCommands())
//									Log.i("Command:", c.toString());
//								Log.i("Transaction", "inside transaction - end");
								for(Command c : transaction.getCommands()){
									//duvida porke a obrigatoriedade do toString(), e a unica maneira aki
//									qual a implicacao de enums no android?? isto so acontece quando limpamos a stack
//									ou seja 
//									se fizermos new receipt e depois back e send funciona assim ou com ==
//									se fizermos new receipt e depois home (limpa a task e fecha db) e send so funciona assim com equals ??
//									c.getType() == CommandType.INSERT -> isto funka no 1º caso no 2º já não :/
//									e é com estas merdas que um gajo perde 10 horas pois este tipo de "erros" nao sao erros mas pronto
									if(c.getTargetLayer().toString().equals(CommandTargetLayer.DATABASE.toString())){
										if(c.getType().toString().equals(CommandType.INSERT.toString())){
//											Log.i("server", "entrei no insert");
//											Log.i("object type", "-" +((ModelMusts) c.getSource()).getType());
											if(Database.get(session, ((ModelMusts) c.getSource()).getType(), ((ModelMusts) c.getSource()).ID(c.getObject())) == null){
	//											condição de ja existencia no server
												Object o = ((ModelMusts) c.getSource()).serverInsert(c.getObject());
												session.store(o);
//												Log.i("object stored", "" + c.getObject().toString());
											}
										}
										if(c.getType().toString().equals(CommandType.UPDATE.toString())){
//											Log.i("server", "update" );
											Object server = Database.get(session, ((ModelMusts) c.getSource()).getType(), ((ModelMusts) c.getSource()).ID(c.getObject()));
//											Object local = Database.get(((ModelMusts) c.getSource()).getType(), ((ModelMusts) c.getSource()).ID(c.getObject()));
											if(server != null){
//												Log.i("server - update", "command source - " + c.getSource().toString());
												((ModelMusts) c.getSource()).serverUpdate(server, c.getObject());
//												Log.i("server - update", "1");
												session.store(server);
//												Log.i("server - update", "2");
	//											Log.i("server - update, insert or delete association", "fiz o store do - " + c.getObject().toString());
											}
										}
										if(c.getType().toString().equals(CommandType.INSERT_ASSOCIATION.toString())){
//											Log.i("server", "insert association" );
											Object server_object = Database.get(session, ((ModelMusts) c.getSource()).getType(), ((ModelMusts) c.getSource()).ID(c.getObject()));
											Object server_neibor = Database.get(session, ((ModelMusts) c.getSource()).getNeiborType(c.getNeibor()), ((ModelMusts) c.getSource()).getNeiborID(c.getNeibor()));
											if(server_object != null && server_neibor != null){
												((ModelMusts) c.getSource()).serverInsertAssociation(server_object, server_neibor);
//												server = Database.get(((ModelMusts) c.getSource()).getType(), c.getoldObject());
												session.store(server_object);
//												Log.i("server - insert association", "fiz o store do - " + c.getObject().toString());
											}
										}
										if(c.getType().toString().equals(CommandType.DELETE_ASSOCIATION.toString())){
//											Log.i("server", "delete association" );
											Object server_oldObject = Database.get(session, ((ModelMusts) c.getSource()).getType(), c.getoldObjectID());
											Object server_oldNeibor = Database.get(session, c.getoldNeiborType(), c.getoldNeiborID());
											if(server_oldObject != null && server_oldNeibor != null){
												((ModelMusts) c.getSource()).serverDeleteAssociation(server_oldObject, server_oldNeibor);
//												server = Database.get(((ModelMusts) c.getSource()).getType(), c.getoldObject());
												session.store(server_oldObject);
//												Log.i("server - delete association", "fiz o store do - " + server_oldObject.toString());
											}
										}
										if(c.getType().toString().equals(CommandType.DELETE.toString())){
											Object temp = Database.get(session, ((ModelMusts) c.getSource()).getType(), c.getoldObjectID());
//											Log.i("server", "entrei no delete" );
//											if((ModelMusts) c.getSource() == null)
//												Log.i("server", "o getsource esta a devolver null" );
											if(temp != null){
												session.delete(temp);
//												Log.i("server - delete", "fiz o delete do " + c.getoldObjectID());
											}
										}
									}
									
								}
//								Receipt x1 = Database.get(client, Receipt.class, 232801085);
//								ManyTMTest y2 = Database.get(client, ManyTMTest.class, -34413197);
//								x1.addOneManyTMTest(y2);
//								client.store(x1);
//								client.commit();
//								Log.i("server all", "" +Database.getAll(session, Receipt.class));
//								Log.i("server all", "" +Database.getAll(session, ManyTMTest.class));
								session.commit();
								Transactions.removeTransaction(transaction);
//								if(transaction != null)
//									Log.i("got transaction", "" + transaction.toString());
							}
						} catch (Exception e3) {
							if(transaction != null)
								UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Connection Warning", "Connection to server was made\nConnection to the database was made\nFailed in setting the transaction: " + transaction.toString() + "\nrolling back changes");
							else
								UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Synchronization", "You have not made any changes\nThere are not any transactions");
							session.rollback();
						} finally {
							Log.i("server actions", "fechei a sessão");
							session.close();
						}
					} catch (Exception e2) {
						error = true;
						UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Connection Warning", "Connection to server was made\nFailed to connect to the database");
					} finally {
						Log.i("server actions", "fechei a ligacao");
						client.close();
					}
				}catch(Exception e1){
					error = true;
					UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Connection Warning", "Connection to server failed\ncheck if you are connected to the internet");
				}
				if(!error)
					UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "objects sent", "objects sent ");
				return null;
			}
		}.execute();
		
	}

	public static void getChanges() {
		get_task = new AsyncTask<Void, String, Boolean>() {
			@Override
			protected Boolean doInBackground(Void... params) {
//				ObjectContainer client = Db4oClientServer.openClient(ServerInfo.HOST, ServerInfo.PORT, ServerInfo.USER,	ServerInfo.PASS);
//				ObjectSet<Object> allObjects = client.query(Object.class);
//				for (Object objectToUpdate : allObjects) {
//				   Log.i("objects in server", "" + objectToUpdate.toString());
//				}
//				Log.i("pedir ver objectos todos", "" + "ja pedi ao server");
				try{
					ObjectContainer client = Db4oClientServer.openClient(ServerInfo.HOST, ServerInfo.PORT, ServerInfo.USER,	ServerInfo.PASS);
					
					try {
						ObjectContainer session = client.ext().openSession();
						try {
							ObjectSet<Object> allObjects = session.query(Object.class);
							Database.close();
							Database.DeleteDB();
							ObjectContainer local = Database.OpenDB();
							for (Object objectToUpdate : allObjects) {
							    local.store(objectToUpdate);
							}
							local.commit();
						} catch (Exception e3) {
							UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Connection  problem", "problem during the storage\nrolling back changes");
						} finally {
							session.close();
						}

					} catch (Exception e2) {
						UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Connection Warning", "Connection to server sucess\nproblem getting session");
					} finally {
						client.close();
					}
				}catch (Exception e1){
					UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Connection Warning", "Connection to server failed\ncheck if you are connected to the internet");
				}
				UtilNavigate.showWarning(MAIN_APPLICATION.getActiveActivity(), "Synchronization sucess", "new DB is ready for use");
				return null;
			}
		}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
	}

	public static void synchronize() {
		sendChanges();
		if(send_task.getStatus() == AsyncTask.Status.FINISHED)
			getChanges();// deve ter ordem com tasks não pode ser so assim
	}
}
